# Step 2: Clean metadata and generate FASTA
configfile: "config/config.yaml"
indir = config["input_namespace"]
outdir = config["output_namespace"]

serotype = ['Dengue_1', 'Dengue_2', 'Dengue_3', 'Dengue_4']

def download(filename):
    from snakemake.remote import AUTO
    try:
        return AUTO.remote(filename)
    except MissingInputException:
        return filename

rule process_dengue_data:
    input:
        metadata = expand("results/{indir}/metadata.tsv", indir=indir),
        fasta = expand("results/{indir}/ncbi_dataset/data/genomic.fna", indir=indir),
        script = download(srcdir("../resources/scripts/Clean_metadata_and_fasta.R")),
    output:
        fasta_files = expand("results/{outdir}/Unaligned_{serotype}.fasta", serotype=serotype, outdir=outdir),
        info_tables_txt = expand("results/{outdir}/{serotype}_infoTbl.txt", serotype=serotype, outdir=outdir),
        info_tables_csv = expand("results/{outdir}/{serotype}_infoTbl.csv", serotype=serotype, outdir=outdir),
    params:
        start_date = "2000-01-01",
        end_date = "2023-12-24",
        outdir = expand("results/{outdir}", outdir=outdir),
    log:
        "logs/process_dengue_data.log"
    message:
        "Processing and cleaning Dengue data downloaded from NCBI"
    conda:
        "envs/dengue.yaml"
    shell:
        """
        rscript {input.script} --metadata {input.metadata} --fasta {input.fasta} --output_dir {params.outdir} --start-date {params.start_date} --end-date {params.end_date}
        """
